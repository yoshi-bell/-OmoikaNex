# 🟢 メタ定義: このファイルの責務 (AIエージェント用)

> **AIエージェントへの指示 (Prompt Repetition Strategy):**
> このファイルは「品質保証の哲学」と「具体的な実装技術」の最高法規を定義しています。
> 1. 実装開始前に「戦略1：エッジケース探索」を必ず実行すること。
> 2. 実装時は「セクション2：技術的実装基準」に従い、堅牢なコードを書くこと。
> 3. PR作成前には「戦略3：敵対的テスト生成」を自己実行し、漏れがないか確認すること。

- **役割:** 品質保証の哲学、AIを活用した「意味のあるテスト」の戦略、具体的なテスト実装基準の定義。
- **読むべきタイミング:** 実装開始前（設計）、テストコード記述時（実装）、PR作成前（検証）。

---

# SNSアプリ 戦略的テスト指針 (Strategic Testing Guide) - 修正提案版

本プロジェクトでは、AIを「テストを書かせる助手」ではなく、**「仕様の穴を突く攻撃者（QAエグゼクティブ）」**として扱い、これまでに培った**「堅牢な実装技術」**の上に、最高精度の品質保証を構築する。

## ⚔️ セクション1：三大テスト戦略 (AI-Driven Strategies)

実装効率と鋭い品質検証を両立させるため、以下の3つの戦略を義務付ける。

### 戦略1: エッジケース探索プロンプト (実装前の義務)
正常系（Happy Path）の実装に入る前に、必ずAIに「バグが起きやすいエッジケース」を網羅的にリストアップさせる。
- **観点:** 境界値（0, 負数, 極大値）、サロゲートペア（絵文字）、不正な入力型（null, undefined）、複雑な組み合わせ。
- **反映:** 抽出されたリストを `TEST_CASES.md` に反映してから実装を開始すること。

### 戦略2: プロパティベーステストの導入 (性質の検証)
個別の値だけでなく、「どのような入力であっても常に満たすべき性質（不変条件）」を定義し、検証する。
- **例:** 
    - 「タイムラインをどれだけスクロールしても、同じツイートが重複して表示されないこと」
    - 「フォローを解除したら、相手のフォロワーリストから自分が消えていること」
- **テンプレート:** AIに「hypothesisのようなプロパティベーステストの考え方で、この機能の不変条件をテストして」と命じる。

### 戦略3: AI対AIの「敵対的テスト生成」 (PR前の義務)
自ら書いたコードを「壊す」ためのテストを、攻撃的な人格で生成し、検証する。
- **プロンプト:** 「あなたは意地悪なQAエンジニアです。このコードの論理矛盾やセキュリティホールを突く、失敗するテストを作成してください」。
- **修正:** この「意地悪なテスト」をパスするようにコードを補強・修正することで、防御力を飛躍的に高める。

---

## 🛠️ セクション2：技術的実装基準 (Technical Implementation Standards)

テストの「保守性」を担保するため、原案から継承した以下の実装詳細を厳守する。

### 1. Backend: API/Service テスト (Pest / PHPUnit)
- **環境:** `RefreshDatabase` を使用し、テスト間の独立性（冪等性）を完全に保証する。
- **検証:** `assertJsonStructure` による構造チェックと、`assertJsonFragment` による重要データの存在確認を行う。
- **認可ガード:** 「他人のリソース（ツイート等）を削除・更新できないか」という異常系テストを必須とする。
- **優先順位:** 認可ガード、バリデーション異常系、およびトークン認証の可否確認を最優先する。

### 2. Frontend: 状態・コンポーネントテスト (Vitest / Testing Library)
- **DOMクエリ:** `within` や `getByRole` を優先使用し、HTML構造やCSSクラスの変更に左右されない「実装詳細に依存しない」堅牢なテストを書く。
- **モック戦略:** `msw` (Mock Service Worker) を活用し、APIのレスポンス（Loading / Error / Success）による UI の状態遷移（ローディング中・エラー・サクセス）を網羅的に検証する。
- **カスタムフック:** 複雑なステート管理（Zustand等）は、UIから切り離して `renderHook` でロジック単体を精密検査する。

### 3. E2E テスト (Playwright)
- **ワークフロー:** ログインから投稿、いいね、ページ遷移までの一連の主要ワークフローの完走を保証する。
- **楽観的UI更新:** 「いいね」等の操作において、API完了を待たずにUIが更新される挙動と、API失敗時の「ロールバック（元の状態に戻る）」をブラウザレベルで確証する。

---

## 💎 セクション3：型安全性と実利的なモック

- **No `any` Policy:** テストコードにおいても `any` は原則禁止。型ガードを駆使して `unknown` を安全に処理する。
- **実利的な例外規定 (原案継承):** 
    - 外部ライブラリ（MSWの複雑な型定義など）の記述が極めて困難な場合に限り、実利的な判断として `any` を許容する。
    - その際は必ず `// eslint-disable-next-line @typescript-eslint/no-explicit-any` を添え、意図的な使用であることを明示すること。
- **アサーションの意図:** `expect(xxx).toBe(yyy)` の羅列ではなく、失敗時に「何が仕様と違ったのか」が伝わるような説明的なテストコード（Intent-focused Assertions）を心がける。
